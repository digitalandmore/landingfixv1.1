<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LandingFix AI ‚Äì Your Landing Page Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="report.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <header class="main-header">
    <a href="index.html">
      <img src="images/logo-header.png" alt="LandingFix AI Logo" class="header-logo">
    </a>
    <p class="sub">Boost your conversions with instant landing page insights powered by AI.</p>
  </header>

  <main>
    <div class="container">
      <h2 class="report-title">üöÄ Your Landing Page Report</h2>
      <div id="dynamic-report-details"></div>
      <div id="report-content">Loading...</div>
    </div>
  </main>

  <footer class="site-footer bg-white">
  <div class="footer-inner">
    <!-- Logo -->
    <img src="images/logo-header.png" alt="LandingFix AI Logo" class="footer-logo">
    
    <!-- Menu -->
    <nav class="footer-menu">
      <a href="index.html">Home</a>
      <span>|</span>
      <a href="privacy-policy.html">Privacy Policy</a>
      <span>|</span>
      <a href="cookie-policy.html">Cookie Policy</a>
      <span>|</span>
      <a href="terms-conditions.html">Terms &amp; Conditions</a>
    </nav>
    
    <p>Developed with ‚ù§Ô∏è by <a href="https://digitalandmore.eu" target="_blank"><strong>DIGITAL&amp;MORE</strong></a></p>
    <p class="footer-copyright">&copy; 2025 LandingFix AI. All rights reserved.</p>
  </div>
</footer>

  <script>
document.addEventListener('DOMContentLoaded', async function() {
  const data = JSON.parse(localStorage.getItem('landingfix_report_data') || '{}');
  if (!data || !data.url) {
    document.getElementById('report-content').textContent = "No data found.";
    return;
  }

  // Loader avanzato con percentuale e step AI
  document.getElementById('report-content').innerHTML = `
    <div class="report-loader">
      <div class="loader-bar-bg">
        <div class="loader-bar-fill" id="reportProgressBar"></div>
      </div>
      <div class="loader-percent" id="loaderPercent">0%</div>
      <div class="loader-steps" id="loaderSteps">
        <div><i class="fa fa-robot"></i> AI is analyzing your landing page...</div>
        <ul id="loaderStepList" class="loader-step-list">
          <li>üîç Structure & Content</li>
          <li>‚úçÔ∏è Copy & CTAs</li>
          <li>üì± Mobile Experience</li>
          <li>‚ö°Ô∏è Technical Performance</li>
          <li>üéØ Conversion Potential</li>
        </ul>
      </div>
      <div class="loader-msg" id="reportLoaderMsg">Starting analysis...</div>
    </div>
  `;

  const steps = [
    "Analyzing structure & content...",
    "Evaluating copy and CTAs...",
    "Reviewing mobile experience...",
    "Checking technical performance...",
    "Assessing conversion potential...",
    "Finalizing your personalized report..."
  ];
  let progress = 0;
  let step = 0;
  const bar = document.getElementById('reportProgressBar');
  const msg = document.getElementById('reportLoaderMsg');
  const percent = document.getElementById('loaderPercent');
  const stepList = document.getElementById('loaderStepList').getElementsByTagName('li');
  const interval = setInterval(() => {
    progress += 100 / steps.length;
    if (bar) bar.style.width = progress + "%";
    if (percent) percent.textContent = Math.round(progress) + "%";
    if (msg && steps[step]) msg.textContent = steps[step];
    if (stepList[step]) stepList[step].style.color = "#27ae60";
    step++;
    if (progress >= 100) clearInterval(interval);
  }, 800);

  // Funzione per mostrare info utente + score
  function renderUserDetails(scoreHtml = '') {
    const detailsDiv = document.getElementById('dynamic-report-details');
    if (detailsDiv) {
      detailsDiv.innerHTML = `
        <div class="report-user-header user-header-flex">
          <div class="user-info-col">
            <div class="user-info-row">
              <div class="user-info-block">
                <div class="user-info-label">
                  <span class="icon-bg"><i class="fa fa-link"></i></span>
                  <span>Landing Page</span>
                </div>
                <a href="${data.url}" target="_blank" class="user-info-value">${data.url}</a>
                <div class="user-info-label">
                  <span class="icon-bg"><i class="fa fa-envelope"></i></span>
                  <span>Email</span>
                </div>
                <span class="user-info-value">${data.email || '-'}</span>
                ${data.company ? `
                <div class="user-info-label">
                  <span class="icon-bg"><i class="fa fa-building"></i></span>
                  <span>Company</span>
                </div>
                <span class="user-info-value">${data.company}</span>
                ` : ''}
                <div class="goals-row">
                  <div class="goals-label">
                    <span class="icon-bg"><i class="fa fa-bullseye"></i></span>
                    <span>Goals</span>
                  </div>
                  <div class="goals-list">
                    ${data.goals && data.goals.length ? data.goals.map(g => `<span class="goal-badge">${g}</span>`).join('') : '<span style="color:#888;">-</span>'}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="score-col">
            ${scoreHtml}
          </div>
        </div>
      `;
    }
  }

  // Funzione per caricare dinamicamente il popup da checkout.html
  function loadCheckoutPopup(callback) {
    if (document.getElementById('checkout-popup')) {
      if (callback) callback();
      return;
    }
    fetch('checkout.html')
      .then(res => res.text())
      .then(html => {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const popup = temp.querySelector('#checkout-popup');
        if (popup) {
          document.body.appendChild(popup);
          if (callback) callback();
        }
      });
  }

  let fullReportHtml = ""; // Salva il report completo per lo sblocco
  let scoreHtml = '';

  try {
    const response = await fetch("https://landingfix-com.onrender.com/api/generate-report", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        url: data.url,
        company: data.company,
        email: data.email,
        goals: data.goals
      })
    });
    const result = await response.json();
    const html = result.choices?.[0]?.message?.content || "No report generated.";
    fullReportHtml = html; // Salva il report completo

    // Estrai lo score dinamico se presente
    const scoreMatch = html.match(/<strong class="score-number">([\d.]+)\s*\/\s*10<\/strong>/i);
    if (scoreMatch) {
      let score = parseFloat(scoreMatch[1]);
      let scoreClass = "red";
      if (score >= 8) scoreClass = "green";
      else if (score > 5) scoreClass = "orange";
      scoreHtml = `
        <div class="score-block">
          <div class="score-label">Score</div>
          <div class="score-circle ${scoreClass}">${score}</div>
          <div class="score-outof">/ 10</div>
        </div>
      `;
    }
    renderUserDetails(scoreHtml);

    // Estrai General Overview (tutto il contenuto)
    const matches = html.match(/<div class="report-section">[\s\S]*?(?=<div class="report-section">|$)/gi) || [];
    const generalOverview = matches.find(section => section.includes('<h4>General Overview</h4>')) || '<div style="color:#c0392b;">General Overview not found.</div>';

    const lockedContent = `
      <div id="locked-report" style="background:#fffbe6;border:1px solid #ffe58f;border-radius:10px;padding:28px 22px;margin:32px auto 0 auto;max-width:600px;text-align:center;box-shadow:0 2px 8px rgba(255,215,0,0.08);">
        <h3 style="color:#e67e22;font-size:1.3em;margin-bottom:12px;"><i class="fa fa-lock"></i> Unlock the Full Report</h3>
        <p style="font-size:1.08em;color:#444;margin-bottom:18px;">
          Go beyond the overview! Unlock your complete AI-powered landing page report and access all actionable insights to maximize your results.
        </p>
        <div style="margin:0 auto 18px auto;display:inline-block;text-align:left;">
          <div style="font-weight:600;color:#222;margin-bottom:6px;">Unlock all categories:</div>
          <ul style="margin:0 0 10px 18px;padding:0;color:#444;font-size:1em;">
            <li>Copywriting &amp; Persuasion</li>
            <li>Design &amp; User Experience</li>
            <li>Technical &amp; Mobile Optimization</li>
            <li>Conversion Potential</li>
          </ul>
          <div style="font-weight:600;color:#222;margin:10px 0 6px 0;">What you'll get:</div>
          <ul style="margin:0 0 0 18px;padding:0;color:#444;font-size:1em;">
            <li>Actionable recommendations for every section</li>
            <li>In-depth AI analysis and expert tips</li>
            <li>Personalized suggestions to boost conversions</li>
            <li>Full report delivered directly to your email</li>
          </ul>
        </div>
        <button id="unlock-btn" style="margin-top:18px;padding:14px 36px;font-size:1.1em;background:#27ae60;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;box-shadow:0 2px 8px rgba(39,174,96,0.13);transition:background 0.2s;">
          <i class="fa fa-unlock"></i> Unlock Full Report
        </button>
        <p style="margin-top:16px;color:#888;font-size:0.97em;">
          Secure checkout. After unlocking, you‚Äôll receive full access and your complete report via email.
        </p>
      </div>
    `;

    document.getElementById('report-content').innerHTML = `
      <div style="margin-bottom:32px;">${generalOverview}</div>
      ${lockedContent}
    `;

    document.getElementById('unlock-btn').onclick = function(e) {
      e.preventDefault();
      loadCheckoutPopup(function() {
        if (typeof window.openCheckout === 'function') {
          window.openCheckout();
        } else {
          document.getElementById('checkout-popup').style.display = 'flex';
        }
      });
    };

    // Funzione globale per sbloccare il report dopo pagamento/coupon
    window.unlockReport = function() {
      // Mostra tutto il report completo
      document.getElementById('report-content').innerHTML = fullReportHtml;
      renderUserDetails(scoreHtml);

            // --- FORM INVIO EMAIL ---
      const reportContent = document.getElementById('report-content');
      if (reportContent) {
        const emailForm = document.createElement('div');
        emailForm.innerHTML = `
          <div style="background:#fff;border-radius:14px;box-shadow:0 2px 12px rgba(0,112,186,0.07);padding:38px 28px 32px 28px;max-width:520px;margin:40px auto 0 auto;text-align:center;">
            <h3 style="font-size:1.35em;color:#0070ba;margin-bottom:10px;font-weight:700;">
              Save Your Full Report
            </h3>
            <p style="color:#444;font-size:1.08em;margin-bottom:22px;">
              Want to implement these improvements later?<br>
              Enter your email below and receive your complete, actionable report directly in your inbox‚Äîso you can boost your results anytime!
            </p>
            <form id="send-report-form" style="margin:0 auto;max-width:420px;text-align:center;">
              <input type="email" id="send-report-email" placeholder="Your email address" required
                style="padding:16px 16px;width:85%;border:1.5px solid #0070ba;border-radius:8px;margin-bottom:16px;font-size:1.13em;">
              <br>
              <button type="submit"
                style="padding:16px 38px;background:#0070ba;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:1.13em;font-weight:700;box-shadow:0 2px 8px rgba(0,112,186,0.10);transition:background 0.2s;">
                <i class="fa fa-envelope"></i> Send Report to My Email
              </button>
              <div id="send-report-msg" style="margin-top:14px;font-size:1.05em;"></div>
            </form>
          </div>
        `;
        reportContent.appendChild(emailForm);

        document.getElementById('send-report-form').onsubmit = async function(e) {
          e.preventDefault();
          const email = document.getElementById('send-report-email').value;
          const msg = document.getElementById('send-report-msg');
          msg.textContent = "Sending...";
          msg.style.color = "#0070ba";
          try {
            const res = await fetch('https://landingfix-com.onrender.com/api/send-report', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                url: data.url,
                html: fullReportHtml,
                email: email,
                name: data.name || '',
                company: data.company || ''
              })
            });
            const result = await res.json();
            if (result.success) {
              msg.textContent = "Report sent successfully! Check your inbox.";
              msg.style.color = "#27ae60";
            } else {
              msg.textContent = "Error sending report.";
              msg.style.color = "#c0392b";
            }
          } catch (err) {
            msg.textContent = "Error sending report.";
            msg.style.color = "#c0392b";
          }
        };
      }
    };

  } catch (e) {
    document.getElementById('report-content').innerHTML = '<div style="color:#c0392b;font-weight:bold;">Error: Unable to connect to the AI report service.</div>';
    document.getElementById('dynamic-report-details').innerHTML = '';
  }
});
</script>
<script src="checkout.js"></script>
</body>
</html>